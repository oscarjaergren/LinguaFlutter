#!/bin/sh
# Pre-commit hook:
#   1. Auto-format staged Dart files and re-stage them.
#   2. Regenerate mocks if any mock-annotated source files changed.
#   3. Run dart analyze --fatal-infos to catch lint/mock drift before push.

STAGED_DART=$(git diff --cached --name-only --diff-filter=ACM -- '*.dart')

if [ -z "$STAGED_DART" ]; then
  exit 0
fi

FORMAT_EXIT=0

# Format only staged Dart files.
OLD_IFS=$IFS
IFS='
'
for file in $STAGED_DART; do
  [ -n "$file" ] || continue
  dart format "$file" || FORMAT_EXIT=$?
done
IFS=$OLD_IFS

if [ $FORMAT_EXIT -ne 0 ]; then
  echo ""
  echo "âŒ dart format failed on one or more staged files."
  exit $FORMAT_EXIT
fi

# Re-stage only Dart files that were originally staged.
OLD_IFS=$IFS
IFS='
'
for file in $STAGED_DART; do
  [ -n "$file" ] || continue
  git add "$file"
done
IFS=$OLD_IFS

# Regenerate mocks if any file with @GenerateMocks annotations was staged.
MOCK_SOURCES=$(echo "$STAGED_DART" | grep -v '\.mocks\.dart$' | xargs grep -l '@GenerateMocks' 2>/dev/null || true)
if [ -n "$MOCK_SOURCES" ]; then
  echo "ğŸ”„ Mock-annotated files changed â€” regenerating mocks..."
  dart run build_runner build --delete-conflicting-outputs
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ build_runner failed. Fix generation errors before committing."
    exit 1
  fi
  # Stage regenerated mock files.
  git add $(git diff --name-only -- '*.mocks.dart')
fi

# Analyze the full project â€” same check CI runs.
echo "ğŸ” Running dart analyze --fatal-infos..."
dart analyze --fatal-infos
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ dart analyze failed. Fix all errors/warnings before committing."
  exit 1
fi

exit 0
