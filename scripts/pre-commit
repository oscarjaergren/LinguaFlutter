#!/bin/sh
# Pre-commit hook: auto-format staged Dart files and re-stage them.

STAGED_DART=$(git diff --cached --name-only --diff-filter=ACM -- '*.dart')

if [ -z "$STAGED_DART" ]; then
  exit 0
fi

FORMAT_EXIT=0

# Format only staged Dart files.
OLD_IFS=$IFS
IFS='
'
for file in $STAGED_DART; do
  [ -n "$file" ] || continue
  dart format "$file" || FORMAT_EXIT=$?
done
IFS=$OLD_IFS

if [ $FORMAT_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå dart format failed on one or more staged files."
  exit $FORMAT_EXIT
fi

# Re-stage only Dart files that were originally staged.
OLD_IFS=$IFS
IFS='
'
for file in $STAGED_DART; do
  [ -n "$file" ] || continue
  git add "$file"
done
IFS=$OLD_IFS

exit 0
