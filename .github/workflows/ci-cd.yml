# ============================================================================
# Full CI/CD Pipeline
# ============================================================================
# Purpose: Comprehensive testing and building for all platforms
# Triggers: Push to master/develop branches, PRs to master
# 
# What it does:
# 1. Analyze & Lint: Check code quality and formatting
# 2. Test: Run unit tests with coverage reporting
# 3. Build: Create builds for Web, Windows, Android, iOS
# 4. Integration Tests: Run integration tests with Docker infrastructure
# 5. Security Scan: Check for dependency vulnerabilities
#
# WARNING: This is a HEAVY workflow - runs on every push to master/develop
# Consider using dev-ci.yml for lighter checks on feature branches
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  analyze:
    name: Analyze and Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .
      
    - name: Analyze project source
      run: flutter analyze --fatal-infos
      
    - name: Check for outdated dependencies
      run: flutter pub outdated

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Run unit tests
      run: flutter test lib/ --coverage --exclude-tags integration
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage/lcov.info
        name: codecov-umbrella
        fail_ci_if_error: false

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build web
      run: flutter build web --release
      
    - name: Upload web build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web/

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build Windows
      run: flutter build windows --release
      
    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/x64/runner/Release/

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build Android APK
      run: flutter build apk --release
      
    # Unsigned AAB - use android-beta-release.yml for signed builds
    - name: Build Android App Bundle
      run: flutter build appbundle --release
      
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        
    - name: Upload Android App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    # No code signing - for App Store submission you need proper certificates
    - name: Build iOS (no signing)
      run: flutter build ios --release --no-codesign
      
    - name: Upload iOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: build/ios/iphoneos/

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [analyze]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Start test infrastructure
      run: |
        docker-compose -f docker-compose.test.yml up -d
        echo "Waiting for services to be healthy..."
        sleep 15

    - name: Wait for database to be ready
      run: |
        timeout 60 bash -c 'until docker exec lingua_test_db pg_isready -U postgres; do sleep 2; done'
        echo "Database is ready"

    - name: Wait for Kong gateway to be ready
      run: |
        timeout 60 bash -c 'until curl -sf http://localhost:8000/rest/v1/ > /dev/null 2>&1; do sleep 2; done' || echo "Kong may not be fully ready, continuing..."

    - name: Create test user
      run: |
        curl -sf -X POST "http://localhost:9999/signup" \
          -H "Content-Type: application/json" \
          -d '{"email":"test@linguaflutter.dev","password":"testpass123"}' || echo "User may already exist"

    - name: Run integration tests
      run: dart test lib/features/card_management/test/integration/ lib/features/streak/test/integration/ --tags integration --timeout 120s

    - name: Stop test infrastructure
      if: always()
      run: docker-compose -f docker-compose.test.yml down -v

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Run security audit
      run: flutter pub deps --json | jq '.packages[] | select(.kind=="direct") | .name' | xargs -I {} sh -c 'echo "Checking {}" && flutter pub deps'
      continue-on-error: true
