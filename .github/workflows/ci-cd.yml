# ============================================================================
# Full CI/CD Pipeline
# ============================================================================
# Purpose: Comprehensive testing and building for all platforms
# Triggers: Push to master/develop branches, PRs to master
# 
# What it does:
# 1. Analyze & Lint: Check code quality and formatting
# 2. Test: Run unit tests with coverage reporting
# 3. Build: Create builds for Web, Windows, Android, iOS
# 4. Integration Tests: Run integration tests with Docker infrastructure
# 5. Security Scan: Check for dependency vulnerabilities
#
# WARNING: This is a HEAVY workflow - runs on every push to master/develop
# Consider using dev-ci.yml for lighter checks on feature branches
# ============================================================================

name: CI/CD Pipeline
run-name: CI/CD Pipeline - ${{ github.event.head_commit.message || github.ref_name }}

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  analyze:
    name: Analyze and Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .
      
    - name: Analyze project source
      run: flutter analyze --fatal-infos
      
    - name: Check for outdated dependencies
      run: flutter pub outdated

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Run unit tests
      run: flutter test lib/ --coverage --exclude-tags integration
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage/lcov.info
        name: codecov-umbrella
        fail_ci_if_error: false

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build web
      run: |
        flutter build web --release \
          --dart-define="SUPABASE_URL=test_url" \
          --dart-define="SUPABASE_ANON_KEY=test_key" \
          --dart-define="GEMINI_API_KEY=" \
          --dart-define="GOOGLE_CLOUD_TTS_API_KEY=" \
          --dart-define="SENTRY_DSN=" \
          --dart-define="SENTRY_ENVIRONMENT=ci" \
          --dart-define="SENTRY_RELEASE=test"
      
    - name: Upload web build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: web-build
        path: build/web/

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build Windows
      run: |
        flutter build windows --release \
          --dart-define="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
          --dart-define="SENTRY_ENVIRONMENT=production"
      
    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: windows-build
        path: build/windows/x64/runner/Release/

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build Android APK
      run: |
        flutter build apk --release \
          --dart-define="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
          --dart-define="SENTRY_ENVIRONMENT=production"
      
    # Unsigned AAB - use android-beta-release.yml for signed builds
    - name: Build Android App Bundle
      run: |
        flutter build appbundle --release \
          --dart-define="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
          --dart-define="SENTRY_ENVIRONMENT=production"
      
    - name: Upload Android APK
      uses: actions/upload-artifact@v6
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        
    - name: Upload Android App Bundle
      uses: actions/upload-artifact@v6
      with:
        name: android-aab
        path: build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [analyze, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    # No code signing - for App Store submission you need proper certificates
    - name: Build iOS (no signing)
      run: |
        flutter build ios --release --no-codesign \
          --dart-define="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
          --dart-define="SENTRY_ENVIRONMENT=production"
      
    - name: Upload iOS build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: ios-build
        path: build/ios/iphoneos/

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [analyze]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: Setup Supabase CLI
      run: |
        curl -L https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
        sudo mv supabase /usr/local/bin/
        supabase --version

    - name: Start Supabase
      run: |
        supabase init
        supabase start --workdir supabase
      env:
        POSTGRES_PASSWORD: postgres
        SUPABASE_DB_PASSWORD: postgres

    - name: Wait for Supabase services
      run: |
        echo "Waiting for Supabase services to be ready..."
        sleep 90
        
        # Verify services are running
        supabase status --workdir supabase

    - name: Setup test user and schema
      run: |
        # Insert test user directly via database
        docker exec $(docker ps -q -f "name=supabase_db") psql -U postgres -d postgres -c "
        INSERT INTO auth.users (id, email, email_confirmed_at, created_at, updated_at)
        VALUES ('00000000-0000-0000-0000-000000000001', 'test@linguaflutter.dev', NOW(), NOW(), NOW())
        ON CONFLICT (id) DO NOTHING;
        
        INSERT INTO auth.identities (id, user_id, identity_data, provider, created_at, updated_at)
        VALUES (gen_random_uuid(), '00000000-0000-0000-0000-000000000001', '{\"email\": \"test@linguaflutter.dev\"}', 'email', NOW(), NOW())
        ON CONFLICT (user_id) DO NOTHING;
        "

    - name: Run all integration tests
      run: |
        echo "Running all integration tests with full Supabase stack"
        flutter test lib/ --tags integration --timeout 120s

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Run security audit
      run: flutter pub deps --json | jq '.packages[] | select(.kind=="direct") | .name' | xargs -I {} sh -c 'echo "Checking {}" && flutter pub deps'
      continue-on-error: true
