# ============================================================================
# Full CI/CD Pipeline
# ============================================================================
# Purpose: Comprehensive testing and building for all platforms
# Triggers: Push to master/develop branches, PRs to master
# 
# What it does:
# 1. Analyze & Lint: Check code quality and formatting
# 2. Test: Run unit tests with coverage reporting
# 3. Build: Create builds for Web, Windows, Android, iOS
# 4. Integration Tests: Run integration tests with Docker infrastructure
# 5. Security Scan: Check for dependency vulnerabilities
#
# WARNING: This is a HEAVY workflow - runs on every push to master/main
# Consider using dev-ci.yml for lighter checks on feature branches
# ============================================================================

name: CI/CD Pipeline
run-name: CI/CD Pipeline - ${{ github.event.head_commit.message || github.ref_name }}

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  analyze:
    name: Analyze and Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.21.0
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .
      
    - name: Analyze project source
      run: flutter analyze --fatal-infos
      
    - name: Check for outdated dependencies
      run: flutter pub outdated

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.21.0
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Run unit tests
      run: flutter test lib/ --coverage --exclude-tags integration
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage/lcov.info
        name: codecov-umbrella
        fail_ci_if_error: false

  build-matrix:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [analyze, test]
    
    strategy:
      matrix:
        include:
          - platform: web
            os: ubuntu-latest
            build-command: build web --release
            artifact-path: build/web/
            artifact-name: web-build
            
          - platform: windows
            os: windows-latest
            build-command: build windows --release
            artifact-path: build/windows/x64/runner/Release/
            artifact-name: windows-build
            
          - platform: android
            os: ubuntu-latest
            build-command: build apk --release
            artifact-path: build/app/outputs/flutter-apk/app-release.apk
            artifact-name: android-apk
            
          - platform: ios
            os: macos-latest
            build-command: build ios --release --no-codesign
            artifact-path: build/ios/iphoneos/
            artifact-name: ios-build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.21.0
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: Build ${{ matrix.platform }}
      shell: bash
      run: |
        flutter ${{ matrix.build-command }} \
          --dart-define="SUPABASE_URL=${{ secrets.SUPABASE_URL }}" \
          --dart-define="SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" \
          --dart-define="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
          --dart-define="GOOGLE_CLOUD_TTS_API_KEY=${{ secrets.GOOGLE_CLOUD_TTS_API_KEY }}" \
          --dart-define="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
          --dart-define="SENTRY_ENVIRONMENT=ci" \
          --dart-define="SENTRY_RELEASE=${{ github.sha }}"
      
    - name: Upload ${{ matrix.platform }} build artifacts
      uses: actions/upload-artifact@v7
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [analyze]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.21.0
      with:
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Generate code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Start Supabase
      run: |
        supabase init --force
        supabase start --workdir supabase
      env:
        POSTGRES_PASSWORD: postgres
        SUPABASE_DB_PASSWORD: postgres

    - name: Wait for Supabase services
      run: |
        echo "Waiting for Supabase services to be ready..."
        sleep 90
        
        # Verify services are running
        supabase status --workdir supabase

    - name: Setup test user and schema
      run: |
        # Insert test user directly via database
        docker exec $(docker ps -q -f "name=supabase_db") psql -U postgres -d postgres -c "
        INSERT INTO auth.users (id, email, email_confirmed_at, created_at, updated_at)
        VALUES ('00000000-0000-0000-0000-000000000001', 'test@linguaflutter.dev', NOW(), NOW(), NOW())
        ON CONFLICT (id) DO UPDATE SET email = EXCLUDED.email, email_confirmed_at = EXCLUDED.email_confirmed_at;
        
        INSERT INTO auth.identities (id, user_id, identity_data, provider, created_at, updated_at)
        VALUES (gen_random_uuid(), '00000000-0000-0000-0000-000000000001', '{\"email\": \"test@linguaflutter.dev\"}', 'email', NOW(), NOW())
        ON CONFLICT (user_id, provider) DO UPDATE SET identity_data = EXCLUDED.identity_data, updated_at = EXCLUDED.updated_at;
        "

    - name: Run all integration tests
      run: |
        echo "Running all integration tests with full Supabase stack"
        flutter test lib/ --tags integration --timeout 120s

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.21.0
      with:
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Run security audit
      run: flutter pub deps --json | jq '.packages[] | select(.kind=="direct") | .name' | xargs -I {} sh -c 'echo "Checking {}" && flutter pub deps'
      continue-on-error: true
